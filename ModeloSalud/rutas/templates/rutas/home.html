{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizaci√≥n de Rutas - Insumos M√©dicos</title>
    <link rel="stylesheet" href="{% static 'rutas/css/rutas.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>üè• Sistema de Salud - IA</h1>
            <div class="nav-links">
                <a href="{% url 'index' %}">üè† Inicio</a>
                <a href="/rutas/" class="active">üó∫Ô∏è Optimizaci√≥n de Rutas</a>
                <a href="{% url 'sentimientos_home' %}">ü§ñ An√°lisis de Sentimientos</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h2>üó∫Ô∏è Optimizaci√≥n de Rutas de Insumos M√©dicos</h2>
            <p>Algoritmo A* (A Estrella) para encontrar la ruta m√°s corta</p>
        </div>

        <!-- Formulario para calcular ruta -->
        <div class="form-card">
            <h3>üìç Selecciona Origen y Destino</h3>
            <form method="POST" action="{% url 'calcular_ruta' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="origen">üè• Ubicaci√≥n de Origen:</label>
                    <select name="origen" id="origen" required>
                        <option value="">-- Selecciona origen --</option>
                        {% for ubicacion in ubicaciones %}
                            <option value="{{ ubicacion }}" {% if origen == ubicacion %}selected{% endif %}>
                                {{ ubicacion }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="destino">üè≠ Ubicaci√≥n de Destino:</label>
                    <select name="destino" id="destino" required>
                        <option value="">-- Selecciona destino --</option>
                        {% for ubicacion in ubicaciones %}
                            <option value="{{ ubicacion }}" {% if destino == ubicacion %}selected{% endif %}>
                                {{ ubicacion }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" class="btn-primary">üîç Calcular Ruta √ìptima</button>
            </form>

            {% if error %}
                <div class="alert alert-error">
                    ‚ö†Ô∏è {{ error }}
                </div>
            {% endif %}
        </div>

        <!-- Resultados -->
        {% if resultado %}
            {% if resultado.exito %}
                <div class="result-card success">
                    <h3>‚úÖ Ruta √ìptima Encontrada</h3>
                    
                    <div class="result-summary">
                        <div class="stat-box">
                            <span class="stat-label">Origen</span>
                            <span class="stat-value">{{ origen }}</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">‚ûî</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Destino</span>
                            <span class="stat-value">{{ destino }}</span>
                        </div>
                        <div class="stat-box highlight">
                            <span class="stat-label">Distancia Total</span>
                            <span class="stat-value">{{ resultado.costo_total }} km</span>
                        </div>
                    </div>

                    <!-- NUEVO: Mapa Visual del Sistema -->
                    <div class="mapa-visual">
                        <h4>üó∫Ô∏è Mapa Visual del Sistema de Distribuci√≥n</h4>
                        <p class="explicacion-mapa">
                            <strong>Ruta √≥ptima resaltada en VERDE</strong> | Todas las conexiones disponibles en gris
                        </p>
                        <canvas id="mapaCanvas" width="800" height="500"></canvas>
                        <div class="leyenda-mapa">
                            <div><span class="color-box origen"></span> Origen ({{ origen }})</div>
                            <div><span class="color-box destino"></span> Destino ({{ destino }})</div>
                            <div><span class="color-box ruta-optima"></span> Ruta √ìptima</div>
                            <div><span class="color-box otras-rutas"></span> Otras Conexiones</div>
                        </div>
                    </div>

                    <div class="ruta-visual">
                        <h4>üìç Recorrido Paso a Paso:</h4>
                        <div class="camino">
                            {% for ubicacion in resultado.camino %}
                                <div class="nodo">
                                    <span class="numero">{{ forloop.counter }}</span>
                                    <span class="nombre">{{ ubicacion }}</span>
                                </div>
                                {% if not forloop.last %}
                                    <div class="flecha">‚Üí</div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Explicaci√≥n simplificada -->
                    <div class="explicacion-simple">
                        <h4>üí° ¬øC√≥mo funciona el Algoritmo A*?</h4>
                        <p class="texto-simple">
                            El algoritmo A* encuentra la ruta m√°s corta explorando de forma inteligente:
                        </p>
                        <div class="pasos-simples">
                            <div class="paso-item">
                                <span class="paso-num">1</span>
                                <div class="paso-desc">
                                    <strong>Comienza</strong> en "{{ origen }}" y calcula distancias a todos sus vecinos
                                </div>
                            </div>
                            <div class="paso-item">
                                <span class="paso-num">2</span>
                                <div class="paso-desc">
                                    <strong>Prioriza</strong> rutas que lo acercan m√°s al destino usando una estimaci√≥n inteligente
                                </div>
                            </div>
                            <div class="paso-item">
                                <span class="paso-num">3</span>
                                <div class="paso-desc">
                                    <strong>Explora</strong> paso a paso hasta encontrar "{{ destino }}" por el camino m√°s corto
                                </div>
                            </div>
                            <div class="paso-item">
                                <span class="paso-num">‚úì</span>
                                <div class="paso-desc">
                                    <strong>Resultado:</strong> {{ resultado.costo_total }} km (la distancia m√°s corta posible)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparaci√≥n de rutas alternativas -->
                    {% if rutas_alternativas %}
                    <div class="comparacion-rutas">
                        <h4>üìä Comparaci√≥n con Rutas Alternativas</h4>
                        <p class="texto-comparacion">
                            A* encuentra la ruta m√°s corta. Aqu√≠ puedes ver otras rutas posibles y por qu√© son m√°s largas:
                        </p>
                        <table class="tabla-comparacion">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Ruta</th>
                                    <th>Distancia</th>
                                    <th>Diferencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="ruta-optima-row">
                                    <td><strong>‚úì √ìPTIMA</strong></td>
                                    <td>
                                        {% for ubicacion in resultado.camino %}
                                            {{ ubicacion }}{% if not forloop.last %} ‚Üí {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td><strong>{{ resultado.costo_total }} km</strong></td>
                                    <td>-</td>
                                </tr>
                                {% for ruta in rutas_alternativas %}
                                <tr>
                                    <td>V√≠a {{ ruta.via }}</td>
                                    <td>
                                        {% for ubicacion in ruta.camino %}
                                            {{ ubicacion }}{% if not forloop.last %} ‚Üí {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>{{ ruta.costo }} km</td>
                                    <td class="diferencia">+{{ ruta.costo|add:"-"|add:resultado.costo_total|floatformat:0 }} km</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="conclusion">
                            üí° <strong>Conclusi√≥n:</strong> La ruta √≥ptima ahorra 
                            {% with primera_alternativa=rutas_alternativas.0 %}
                                {{ primera_alternativa.costo|add:"-"|add:resultado.costo_total|floatformat:0 }} km
                            {% endwith %}
                            comparado con la alternativa m√°s cercana.
                        </p>
                    </div>
                    {% endif %}

                    <!-- Tabla de pasos (colapsable para simplicidad) -->
                    <details class="detalles-algoritmo">
                        <summary>üîç Ver detalles t√©cnicos del algoritmo (opcional)</summary>
                        <div class="pasos-algoritmo">
                            <p class="explicacion">
                                F√≥rmula utilizada: <strong>f(n) = g(n) + h(n)</strong><br>
                                ‚Ä¢ <strong>g(n)</strong> = Distancia real recorrida desde el origen<br>
                                ‚Ä¢ <strong>h(n)</strong> = Estimaci√≥n de distancia restante al destino<br>
                                ‚Ä¢ <strong>f(n)</strong> = Costo total estimado (el algoritmo elige el menor)
                            </p>
                            
                            <table class="tabla-pasos">
                                <thead>
                                    <tr>
                                        <th>Paso</th>
                                        <th>Nodo Explorado</th>
                                        <th>Distancia Real g(n)</th>
                                        <th>Estimaci√≥n h(n)</th>
                                        <th>Total f(n)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for paso in resultado.pasos %}
                                        <tr>
                                            <td>{{ paso.paso }}</td>
                                            <td class="nodo-nombre">{{ paso.nodo_explorado }}</td>
                                            <td>{{ paso.costo_acumulado|floatformat:1 }} km</td>
                                            <td>{{ paso.heuristica|floatformat:1 }} km</td>
                                            <td><strong>{{ paso.costo_acumulado|add:paso.heuristica|floatformat:1 }} km</strong></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </details>
                </div>

                <!-- Script para dibujar el mapa -->
                <script>
                    // Datos del grafo
                    const ubicaciones = {
                        'Hospital': {x: 0, y: 0},
                        'Bodega Central': {x: 5, y: 3},
                        'Centro Distribucion': {x: 3, y: 5},
                        'Farmacia Principal': {x: 7, y: 2},
                        'Almacen Regional': {x: 10, y: 6},
                        'Fabrica Insumos': {x: 12, y: 8}
                    };

                    const conexiones = [
                        ['Hospital', 'Bodega Central', 6],
                        ['Hospital', 'Centro Distribucion', 7],
                        ['Bodega Central', 'Farmacia Principal', 4],
                        ['Bodega Central', 'Centro Distribucion', 3],
                        ['Centro Distribucion', 'Almacen Regional', 8],
                        ['Farmacia Principal', 'Almacen Regional', 5],
                        ['Almacen Regional', 'Fabrica Insumos', 4]
                    ];

                    const rutaOptima = {{ resultado.camino|safe }};
                    const origen = "{{ origen }}";
                    const destino = "{{ destino }}";

                    // Dibujar el mapa
                    window.onload = function() {
                        const canvas = document.getElementById('mapaCanvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Escala y offset para centrar el mapa
                        const escala = 50;
                        const offsetX = 80;
                        const offsetY = 60;

                        // Funci√≥n para convertir coordenadas
                        function coord(x, y) {
                            return {
                                x: x * escala + offsetX,
                                y: canvas.height - (y * escala + offsetY)
                            };
                        }

                        // Dibujar todas las conexiones en gris
                        ctx.strokeStyle = '#ddd';
                        ctx.lineWidth = 2;
                        conexiones.forEach(([origen, destino, costo]) => {
                            const inicio = coord(ubicaciones[origen].x, ubicaciones[origen].y);
                            const fin = coord(ubicaciones[destino].x, ubicaciones[destino].y);
                            
                            ctx.beginPath();
                            ctx.moveTo(inicio.x, inicio.y);
                            ctx.lineTo(fin.x, fin.y);
                            ctx.stroke();

                            // Mostrar distancia
                            const midX = (inicio.x + fin.x) / 2;
                            const midY = (inicio.y + fin.y) / 2;
                            ctx.fillStyle = '#999';
                            ctx.font = '11px Arial';
                            ctx.fillText(costo + ' km', midX + 5, midY - 5);
                        });

                        // Dibujar la ruta √≥ptima en VERDE
                        ctx.strokeStyle = '#10b981';
                        ctx.lineWidth = 5;
                        for (let i = 0; i < rutaOptima.length - 1; i++) {
                            const inicio = coord(ubicaciones[rutaOptima[i]].x, ubicaciones[rutaOptima[i]].y);
                            const fin = coord(ubicaciones[rutaOptima[i + 1]].x, ubicaciones[rutaOptima[i + 1]].y);
                            
                            ctx.beginPath();
                            ctx.moveTo(inicio.x, inicio.y);
                            ctx.lineTo(fin.x, fin.y);
                            ctx.stroke();

                            // Flecha direccional
                            const angle = Math.atan2(fin.y - inicio.y, fin.x - inicio.x);
                            const arrowSize = 10;
                            ctx.fillStyle = '#10b981';
                            ctx.beginPath();
                            ctx.moveTo(fin.x, fin.y);
                            ctx.lineTo(fin.x - arrowSize * Math.cos(angle - Math.PI/6), fin.y - arrowSize * Math.sin(angle - Math.PI/6));
                            ctx.lineTo(fin.x - arrowSize * Math.cos(angle + Math.PI/6), fin.y - arrowSize * Math.sin(angle + Math.PI/6));
                            ctx.closePath();
                            ctx.fill();
                        }

                        // Dibujar los nodos
                        Object.keys(ubicaciones).forEach(nombre => {
                            const pos = coord(ubicaciones[nombre].x, ubicaciones[nombre].y);
                            
                            // Color seg√∫n si es origen, destino u otro
                            if (nombre === origen) {
                                ctx.fillStyle = '#3b82f6'; // Azul - Origen
                            } else if (nombre === destino) {
                                ctx.fillStyle = '#ef4444'; // Rojo - Destino
                            } else if (rutaOptima.includes(nombre)) {
                                ctx.fillStyle = '#10b981'; // Verde - Parte de la ruta
                            } else {
                                ctx.fillStyle = '#6b7280'; // Gris - Otros
                            }

                            // C√≠rculo del nodo
                            ctx.beginPath();
                            ctx.arc(pos.x, pos.y, 15, 0, Math.PI * 2);
                            ctx.fill();

                            // Borde blanco
                            ctx.strokeStyle = '#fff';
                            ctx.lineWidth = 3;
                            ctx.stroke();

                            // Etiqueta
                            ctx.fillStyle = '#1f2937';
                            ctx.font = 'bold 12px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(nombre, pos.x, pos.y + 30);
                        });
                    };
                </script>
            {% else %}
                <div class="result-card error">
                    <h3>‚ùå No se encontr√≥ una ruta</h3>
                    <p>{{ resultado.error }}</p>
                </div>
            {% endif %}
        {% endif %}

        <!-- Informaci√≥n sobre el sistema -->
        <div class="info-card">
            <h3>‚ÑπÔ∏è Informaci√≥n del Sistema</h3>
            
            <div class="sistema-info">
                <div class="info-seccion">
                    <h4>üìç Red de Distribuci√≥n</h4>
                    <p><strong>{{ ubicaciones|length }} ubicaciones</strong> conectadas en el sistema:</p>
                    <ul class="ubicaciones-lista">
                        {% for ubicacion in ubicaciones %}
                            <li>{{ ubicacion }}</li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="info-algoritmo">
                    <h4>üß† ¬øPor qu√© usar el Algoritmo A*?</h4>
                    <div class="ventajas-grid">
                        <div class="ventaja-item">
                            <span class="icono">üéØ</span>
                            <h5>√ìptimo</h5>
                            <p>Siempre encuentra la ruta m√°s corta posible</p>
                        </div>
                        <div class="ventaja-item">
                            <span class="icono">‚ö°</span>
                            <h5>Eficiente</h5>
                            <p>Explora menos caminos que otros algoritmos</p>
                        </div>
                        <div class="ventaja-item">
                            <span class="icono">üß≠</span>
                            <h5>Inteligente</h5>
                            <p>Usa heur√≠stica para priorizar rutas prometedoras</p>
                        </div>
                        <div class="ventaja-item">
                            <span class="icono">‚úÖ</span>
                            <h5>Garantizado</h5>
                            <p>Resultado verificable y reproducible</p>
                        </div>
                    </div>
                </div>

                <div class="aplicaciones-info">
                    <h4>üè• Aplicaciones en Salud</h4>
                    <ul class="aplicaciones-lista">
                        <li><strong>Distribuci√≥n de medicamentos:</strong> Entrega r√°pida a hospitales</li>
                        <li><strong>Rutas de ambulancia:</strong> Caminos √≥ptimos en emergencias</li>
                        <li><strong>Log√≠stica de insumos:</strong> Reducci√≥n de costos y tiempo</li>
                        <li><strong>Planificaci√≥n de cadena de fr√≠o:</strong> Transporte eficiente de vacunas</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Sistema de Inteligencia Artificial para Optimizaci√≥n de Rutas | Proyecto Salud 2025</p>
    </footer>
</body>
</html>
