{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredicciÃ³n de Demanda - Sistema IA</title>
    <link rel="stylesheet" href="{% static 'prediccion/css/prediccion.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ¥ Sistema de Salud - IA</h1>
            <div class="nav-links">
                <a href="{% url 'index' %}">ğŸ  Inicio</a>
                <a href="/prediccion/" class="active">ğŸ“Š PredicciÃ³n de Demanda</a>
                <a href="/rutas/">ğŸ—ºï¸ Rutas</a>
                <a href="{% url 'sentimientos_home' %}">ğŸ¤– Sentimientos</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h2>ğŸ“Š PredicciÃ³n de Demanda de Pacientes</h2>
            <p>Sistema de regresiÃ³n lineal para predecir afluencia diaria/semanal</p>
        </div>

        <!-- Mensajes -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Estado del modelo -->
        <div class="status-card">
            <div class="status-icon">
                {% if modelo_entrenado %}
                    âœ…
                {% else %}
                    âš ï¸
                {% endif %}
            </div>
            <div class="status-info">
                <h3>
                    {% if modelo_entrenado %}
                        Modelo Entrenado y Listo
                    {% else %}
                        Modelo No Entrenado
                    {% endif %}
                </h3>
                <p>Registros histÃ³ricos: {{ total_registros }}</p>
            </div>
        </div>

        <!-- Grid de acciones -->
        <div class="actions-grid">
            <div class="action-card">
                <div class="card-icon">ğŸ§ </div>
                <h3>Entrenar Modelo</h3>
                <p>Entrena el modelo de regresiÃ³n lineal con los datos histÃ³ricos</p>
                <a href="{% url 'entrenar_prediccion' %}" class="btn btn-success">Entrenar Modelo</a>
            </div>

            <div class="action-card">
                <div class="card-icon">ğŸ”®</div>
                <h3>Hacer PredicciÃ³n</h3>
                <p>Predice demanda para fechas futuras (dÃ­a o semana completa)</p>
                <a href="{% url 'hacer_prediccion' %}" class="btn btn-info {% if not modelo_entrenado %}disabled{% endif %}">
                    Predecir
                </a>
            </div>

            <div class="action-card">
                <div class="card-icon">ğŸ“ˆ</div>
                <h3>Ver HistÃ³rico</h3>
                <p>Consulta los datos histÃ³ricos de demanda registrados</p>
                <a href="{% url 'ver_historico' %}" class="btn btn-secondary">Ver HistÃ³rico</a>
            </div>
        </div>

        <!-- VisualizaciÃ³n de datos histÃ³ricos -->
        {% if ultimos_registros %}
        <div class="recent-card">
            <h3>ğŸ“… Ãšltimos 7 DÃ­as Registrados</h3>
            
            <!-- GrÃ¡fico de barras visual -->
            <div class="chart-container">
                <canvas id="chartHistorico" width="800" height="300"></canvas>
            </div>

            <!-- Tabla de datos -->
            <details class="data-details">
                <summary>ğŸ“Š Ver tabla de datos detallada</summary>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>DÃ­a</th>
                            <th>Pacientes</th>
                            <th>Feriado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registro in ultimos_registros %}
                        <tr>
                            <td>{{ registro.fecha }}</td>
                            <td>
                                {% if registro.dia_semana == 0 %}Lunes
                                {% elif registro.dia_semana == 1 %}Martes
                                {% elif registro.dia_semana == 2 %}MiÃ©rcoles
                                {% elif registro.dia_semana == 3 %}Jueves
                                {% elif registro.dia_semana == 4 %}Viernes
                                {% elif registro.dia_semana == 5 %}SÃ¡bado
                                {% else %}Domingo{% endif %}
                            </td>
                            <td><strong>{{ registro.pacientes }}</strong></td>
                            <td>{% if registro.es_feriado %}SÃ­{% else %}No{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </details>
        </div>

        <script>
            // Datos para el grÃ¡fico
            const datos = [
                {% for registro in ultimos_registros reversed %}
                {
                    fecha: '{{ registro.fecha|date:"d/m" }}',
                    dia: '{% if registro.dia_semana == 0 %}Lun{% elif registro.dia_semana == 1 %}Mar{% elif registro.dia_semana == 2 %}MiÃ©{% elif registro.dia_semana == 3 %}Jue{% elif registro.dia_semana == 4 %}Vie{% elif registro.dia_semana == 5 %}SÃ¡b{% else %}Dom{% endif %}',
                    pacientes: {{ registro.pacientes }},
                    feriado: {% if registro.es_feriado %}true{% else %}false{% endif %}
                },
                {% endfor %}
            ];

            // Dibujar grÃ¡fico
            window.onload = function() {
                const canvas = document.getElementById('chartHistorico');
                const ctx = canvas.getContext('2d');
                
                const padding = 50;
                const chartWidth = canvas.width - padding * 2;
                const chartHeight = canvas.height - padding * 2;
                
                // Encontrar mÃ¡ximo para escala
                const maxPacientes = Math.max(...datos.map(d => d.pacientes));
                const escalaY = chartHeight / maxPacientes;
                
                // Ancho de cada barra
                const barWidth = chartWidth / datos.length;
                
                // Limpiar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Dibujar tÃ­tulo
                ctx.fillStyle = '#333';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Tendencia de Pacientes (Ãšltimos 7 DÃ­as)', canvas.width / 2, 25);
                
                // Dibujar lÃ­neas de referencia
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = padding + (chartHeight / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(canvas.width - padding, y);
                    ctx.stroke();
                    
                    // Etiquetas del eje Y
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    const valor = Math.round(maxPacientes * (1 - i / 4));
                    ctx.fillText(valor, padding - 10, y + 4);
                }
                
                // Dibujar barras
                datos.forEach((dato, index) => {
                    const x = padding + index * barWidth + barWidth * 0.1;
                    const barHeight = dato.pacientes * escalaY;
                    const y = canvas.height - padding - barHeight;
                    const actualBarWidth = barWidth * 0.8;
                    
                    // Color segÃºn si es feriado o no
                    if (dato.feriado) {
                        ctx.fillStyle = '#f59e0b';
                    } else if (dato.dia === 'SÃ¡b' || dato.dia === 'Dom') {
                        ctx.fillStyle = '#8b5cf6';
                    } else {
                        ctx.fillStyle = '#667eea';
                    }
                    
                    // Dibujar barra con bordes redondeados
                    ctx.beginPath();
                    ctx.roundRect(x, y, actualBarWidth, barHeight, 5);
                    ctx.fill();
                    
                    // Valor encima de la barra
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(dato.pacientes, x + actualBarWidth / 2, y - 5);
                    
                    // Etiqueta del dÃ­a
                    ctx.fillStyle = '#666';
                    ctx.font = '11px Arial';
                    ctx.fillText(dato.dia, x + actualBarWidth / 2, canvas.height - padding + 15);
                    ctx.fillText(dato.fecha, x + actualBarWidth / 2, canvas.height - padding + 28);
                });
                
                // Leyenda
                const legendY = canvas.height - 10;
                const legendItems = [
                    { color: '#667eea', text: 'DÃ­a normal' },
                    { color: '#8b5cf6', text: 'Fin de semana' },
                    { color: '#f59e0b', text: 'Feriado' }
                ];
                
                let legendX = padding;
                legendItems.forEach(item => {
                    ctx.fillStyle = item.color;
                    ctx.fillRect(legendX, legendY - 10, 15, 15);
                    ctx.fillStyle = '#666';
                    ctx.font = '11px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(item.text, legendX + 20, legendY);
                    legendX += 120;
                });
                
                // Polyfill para roundRect
                if (!ctx.roundRect) {
                    ctx.roundRect = function(x, y, w, h, r) {
                        this.moveTo(x + r, y);
                        this.lineTo(x + w - r, y);
                        this.arcTo(x + w, y, x + w, y + r, r);
                        this.lineTo(x + w, y + h - r);
                        this.arcTo(x + w, y + h, x + w - r, y + h, r);
                        this.lineTo(x + r, y + h);
                        this.arcTo(x, y + h, x, y + h - r, r);
                        this.lineTo(x, y + r);
                        this.arcTo(x, y, x + r, y, r);
                        this.closePath();
                    };
                }
            };
        </script>
        {% endif %}

        <!-- ExplicaciÃ³n visual del modelo -->
        <div class="info-section">
            <h3>ğŸ§  Â¿CÃ³mo Funciona la PredicciÃ³n?</h3>
            
            <div class="proceso-visual">
                <div class="paso-proceso">
                    <div class="paso-numero">1</div>
                    <div class="paso-contenido">
                        <h4>ğŸ“¥ Datos HistÃ³ricos</h4>
                        <p>Se recopilan datos pasados: dÃ­a de la semana, mes, si es feriado y cantidad de pacientes</p>
                        <div class="ejemplo-dato">
                            <span class="dato-item">Lunes</span>
                            <span class="dato-item">Marzo</span>
                            <span class="dato-item">No feriado</span>
                            <span class="dato-resultado">â†’ 36 pacientes</span>
                        </div>
                    </div>
                </div>

                <div class="flecha-proceso">â†“</div>

                <div class="paso-proceso">
                    <div class="paso-numero">2</div>
                    <div class="paso-contenido">
                        <h4>ğŸ§® Entrenamiento del Modelo</h4>
                        <p>El algoritmo aprende patrones: "Los lunes hay mÃ¡s pacientes", "Los feriados hay menos"</p>
                        <div class="formula-visual">
                            <span class="formula-texto">Pacientes = </span>
                            <span class="formula-var">Base</span>
                            <span class="formula-texto"> + </span>
                            <span class="formula-var">Efecto_DÃ­a</span>
                            <span class="formula-texto"> + </span>
                            <span class="formula-var">Efecto_Mes</span>
                            <span class="formula-texto"> - </span>
                            <span class="formula-var">Efecto_Feriado</span>
                        </div>
                    </div>
                </div>

                <div class="flecha-proceso">â†“</div>

                <div class="paso-proceso">
                    <div class="paso-numero">3</div>
                    <div class="paso-contenido">
                        <h4>ğŸ”® PredicciÃ³n Nueva</h4>
                        <p>Dado un nuevo dÃ­a, el modelo calcula cuÃ¡ntos pacientes habrÃ¡</p>
                        <div class="ejemplo-prediccion">
                            <div class="pred-input">
                                <strong>Entrada:</strong> Martes, Noviembre, Feriado
                            </div>
                            <div class="pred-arrow">â†’</div>
                            <div class="pred-output">
                                <strong>PredicciÃ³n:</strong> ~18 pacientes
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- InformaciÃ³n del algoritmo en grid -->
            <div class="info-grid">
                <div class="info-box">
                    <div class="info-icon">ğŸ¯</div>
                    <h4>Algoritmo</h4>
                    <p><strong>RegresiÃ³n Lineal MÃºltiple</strong></p>
                    <p class="info-desc">Encuentra la mejor lÃ­nea que se ajusta a los datos histÃ³ricos</p>
                </div>
                <div class="info-box">
                    <div class="info-icon">ğŸ“Š</div>
                    <h4>Variables de Entrada</h4>
                    <p><strong>3 factores principales:</strong></p>
                    <ul class="variables-list">
                        <li>DÃ­a de la semana (0-6)</li>
                        <li>Mes del aÃ±o (1-12)</li>
                        <li>Â¿Es feriado? (SÃ­/No)</li>
                    </ul>
                </div>
                <div class="info-box">
                    <div class="info-icon">ğŸ”¬</div>
                    <h4>Tipo de Aprendizaje</h4>
                    <p><strong>Supervisado</strong></p>
                    <p class="info-desc">Aprende de ejemplos etiquetados con respuestas correctas</p>
                </div>
                <div class="info-box">
                    <div class="info-icon">âœ…</div>
                    <h4>Ventajas</h4>
                    <ul class="ventajas-list">
                        <li>âš¡ RÃ¡pido y eficiente</li>
                        <li>ğŸ“– FÃ¡cil de interpretar</li>
                        <li>ğŸ¯ Preciso para patrones lineales</li>
                        <li>ğŸ’¾ Poco uso de recursos</li>
                    </ul>
                </div>
            </div>

            <!-- Aplicaciones prÃ¡cticas -->
            <div class="aplicaciones-card">
                <h4>ğŸ¥ Aplicaciones en el Sector Salud</h4>
                <div class="aplicaciones-grid">
                    <div class="aplicacion-item">
                        <span class="app-icon">ğŸ‘¨â€âš•ï¸</span>
                        <h5>Personal MÃ©dico</h5>
                        <p>Planificar turnos segÃºn demanda esperada</p>
                    </div>
                    <div class="aplicacion-item">
                        <span class="app-icon">ğŸ’Š</span>
                        <h5>Insumos</h5>
                        <p>Asegurar stock suficiente de medicamentos</p>
                    </div>
                    <div class="aplicacion-item">
                        <span class="app-icon">ğŸ›ï¸</span>
                        <h5>Camas</h5>
                        <p>Gestionar disponibilidad de camas</p>
                    </div>
                    <div class="aplicacion-item">
                        <span class="app-icon">ğŸ’°</span>
                        <h5>Presupuesto</h5>
                        <p>Optimizar costos operacionales</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Sistema de PredicciÃ³n de Demanda | Proyecto IA 2025</p>
    </footer>
</body>
</html>
