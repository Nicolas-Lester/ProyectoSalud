{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacer Predicci√≥n - Sistema IA</title>
    <link rel="stylesheet" href="{% static 'prediccion/css/prediccion.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>üè• Sistema de Salud - IA</h1>
            <div class="nav-links">
                <a href="{% url 'index' %}">üè† Inicio</a>
                <a href="/prediccion/">üìä Dashboard</a>
                <a href="/rutas/">üó∫Ô∏è Rutas</a>
                <a href="{% url 'sentimientos_home' %}">ü§ñ Sentimientos</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h2>üîÆ Predecir Demanda de Pacientes</h2>
            <p>Ingresa una fecha para predecir cu√°ntos pacientes habr√°</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Formulario de predicci√≥n -->
        <div class="form-card">
            <h3>üìÖ Configurar Predicci√≥n</h3>
            <form method="POST">
                {% csrf_token %}
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fecha">Fecha:</label>
                        <input type="date" 
                               name="fecha" 
                               id="fecha" 
                               required 
                               min="{{ fecha_minima }}"
                               value="{% now 'Y-m-d' %}">
                    </div>

                    <div class="form-group">
                        <label for="tipo">Tipo de Predicci√≥n:</label>
                        <select name="tipo" id="tipo">
                            <option value="dia">Un solo d√≠a</option>
                            <option value="semana">Semana completa (7 d√≠as)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="es_feriado" id="es_feriado">
                        <span>¬øEs feriado?</span>
                    </label>
                    <p class="help-text">Los feriados t√≠picamente tienen menos demanda</p>
                </div>

                <button type="submit" class="btn btn-primary btn-large">
                    üîÆ Generar Predicci√≥n
                </button>
            </form>
        </div>

        <!-- Resultados de predicci√≥n -->
        {% if predicciones %}
        <div class="results-section">
            <h3>‚ú® Resultados de la Predicci√≥n</h3>
            
            {% if predicciones|length == 1 %}
                <!-- Predicci√≥n de un solo d√≠a -->
                {% for pred in predicciones %}
                <div class="prediction-card single">
                    <div class="pred-header">
                        <div class="pred-date">
                            <span class="date-day">{{ pred.dia_nombre }}</span>
                            <span class="date-full">{{ pred.fecha }}</span>
                        </div>
                        <div class="pred-badge {% if pred.es_feriado %}holiday{% endif %}">
                            {% if pred.es_feriado %}üéâ Feriado{% else %}üìÖ D√≠a Normal{% endif %}
                        </div>
                    </div>
                    
                    <div class="pred-result">
                        <div class="result-icon">üë•</div>
                        <div class="result-number">{{ pred.pacientes_predichos }}</div>
                        <div class="result-label">Pacientes Esperados</div>
                    </div>

                    <div class="pred-details">
                        <div class="detail-item">
                            <span class="detail-label">D√≠a de la semana:</span>
                            <span class="detail-value">{{ pred.dia_nombre }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Mes:</span>
                            <span class="detail-value">Mes {{ pred.mes }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Tipo de d√≠a:</span>
                            <span class="detail-value">
                                {% if pred.es_feriado %}Feriado{% else %}Laboral{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}

            {% else %}
                <!-- Predicci√≥n de semana completa -->
                <div class="week-predictions">
                    <div class="week-summary">
                        <h4>üìä Resumen Semanal</h4>
                        {% with total=predicciones|length %}
                        {% with sum_pacientes=0 %}
                        {% for pred in predicciones %}
                            {% with sum_pacientes=sum_pacientes|add:pred.pacientes_predichos %}{% endwith %}
                        {% endfor %}
                        <div class="summary-stats">
                            <div class="stat">
                                <span class="stat-label">Total Semana:</span>
                                <span class="stat-value">
                                    {% widthratio predicciones|length 1 1 %} d√≠as
                                </span>
                            </div>
                        </div>
                        {% endwith %}
                        {% endwith %}
                    </div>

                    <div class="week-grid">
                        {% for pred in predicciones %}
                        <div class="day-card">
                            <div class="day-header">
                                <span class="day-name">{{ pred.dia_nombre }}</span>
                                <span class="day-date">{{ pred.fecha|date:"d/m" }}</span>
                            </div>
                            <div class="day-prediction">
                                <span class="prediction-number">{{ pred.pacientes_predichos }}</span>
                                <span class="prediction-label">pacientes</span>
                            </div>
                            {% if pred.es_feriado %}
                            <div class="day-badge holiday">Feriado</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Explicaci√≥n visual simplificada -->
            <div class="explanation-card">
                <h4>üß† ¬øC√≥mo se calcul√≥ esta predicci√≥n?</h4>
                <div class="proceso-prediccion">
                    <div class="paso-pred">
                        <div class="paso-pred-num">1</div>
                        <div class="paso-pred-contenido">
                            <h5>üì• Extracci√≥n de Caracter√≠sticas</h5>
                            <p>Se tom√≥ la fecha y se extrajo:</p>
                            <div class="caracteristicas">
                                <span class="caract-item">D√≠a de semana</span>
                                <span class="caract-item">Mes del a√±o</span>
                                <span class="caract-item">¬øEs feriado?</span>
                            </div>
                        </div>
                    </div>
                    <div class="paso-pred">
                        <div class="paso-pred-num">2</div>
                        <div class="paso-pred-contenido">
                            <h5>üî¢ Normalizaci√≥n</h5>
                            <p>Los valores se ajustaron a una escala est√°ndar para que el modelo los entienda mejor</p>
                        </div>
                    </div>
                    <div class="paso-pred">
                        <div class="paso-pred-num">3</div>
                        <div class="paso-pred-contenido">
                            <h5>üéØ Aplicaci√≥n del Modelo</h5>
                            <p>Se us√≥ la f√≥rmula aprendida del entrenamiento:</p>
                            <div class="formula-simple">
                                Pacientes = Base + Efecto_D√≠a + Efecto_Mes - Reducci√≥n_Feriado
                            </div>
                        </div>
                    </div>
                    <div class="paso-pred">
                        <div class="paso-pred-num">‚úì</div>
                        <div class="paso-pred-contenido">
                            <h5>‚ú® Resultado Final</h5>
                            <p>El modelo calcul√≥ el n√∫mero esperado de pacientes bas√°ndose en patrones hist√≥ricos</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de comparaci√≥n visual -->
            {% if predicciones|length > 1 %}
            <div class="chart-predicciones">
                <h4>üìä Visualizaci√≥n de Predicciones</h4>
                <canvas id="chartPredicciones" width="800" height="300"></canvas>
            </div>

            <script>
                const predicciones = [
                    {% for pred in predicciones %}
                    {
                        dia: '{{ pred.dia_nombre|slice:":3" }}',
                        fecha: '{{ pred.fecha|date:"d/m" }}',
                        pacientes: {{ pred.pacientes_predichos }},
                        feriado: {% if pred.es_feriado %}true{% else %}false{% endif %}
                    },
                    {% endfor %}
                ];

                window.addEventListener('load', function() {
                    const canvas = document.getElementById('chartPredicciones');
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    const padding = 50;
                    const chartWidth = canvas.width - padding * 2;
                    const chartHeight = canvas.height - padding * 2;
                    
                    const maxPacientes = Math.max(...predicciones.map(p => p.pacientes));
                    const escalaY = chartHeight / maxPacientes;
                    const barWidth = chartWidth / predicciones.length;
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // T√≠tulo
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Predicci√≥n Semanal de Pacientes', canvas.width / 2, 25);
                    
                    // L√≠neas de referencia
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.lineWidth = 1;
                    for (let i = 0; i <= 4; i++) {
                        const y = padding + (chartHeight / 4) * i;
                        ctx.beginPath();
                        ctx.moveTo(padding, y);
                        ctx.lineTo(canvas.width - padding, y);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#666';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'right';
                        const valor = Math.round(maxPacientes * (1 - i / 4));
                        ctx.fillText(valor, padding - 10, y + 4);
                    }
                    
                    // Dibujar barras
                    predicciones.forEach((pred, index) => {
                        const x = padding + index * barWidth + barWidth * 0.1;
                        const barHeight = pred.pacientes * escalaY;
                        const y = canvas.height - padding - barHeight;
                        const actualBarWidth = barWidth * 0.8;
                        
                        // Gradiente para las barras
                        const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                        if (pred.feriado) {
                            gradient.addColorStop(0, '#f59e0b');
                            gradient.addColorStop(1, '#d97706');
                        } else {
                            gradient.addColorStop(0, '#667eea');
                            gradient.addColorStop(1, '#764ba2');
                        }
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, y, actualBarWidth, barHeight);
                        
                        // Borde
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y, actualBarWidth, barHeight);
                        
                        // Valor
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 14px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(pred.pacientes, x + actualBarWidth / 2, y - 8);
                        
                        // Etiquetas
                        ctx.fillStyle = '#666';
                        ctx.font = 'bold 12px Arial';
                        ctx.fillText(pred.dia, x + actualBarWidth / 2, canvas.height - padding + 18);
                        ctx.font = '10px Arial';
                        ctx.fillText(pred.fecha, x + actualBarWidth / 2, canvas.height - padding + 32);
                    });
                });
            </script>
            {% endif %}
        </div>
        {% endif %}

        <!-- Informaci√≥n adicional -->
        <div class="info-panel">
            <h4>üí° Consejos para mejores predicciones:</h4>
            <ul>
                <li>Los lunes suelen tener mayor demanda (acumulaci√≥n del fin de semana)</li>
                <li>Los fines de semana t√≠picamente tienen menos pacientes</li>
                <li>Los feriados reducen la demanda aproximadamente un 40%</li>
                <li>El verano (Enero-Febrero) suele tener mayor afluencia</li>
                <li>El modelo mejora con m√°s datos hist√≥ricos</li>
            </ul>
        </div>
    </div>

    <footer>
        <p>Sistema de Predicci√≥n de Demanda | Proyecto IA 2025</p>
    </footer>
</body>
</html>
